{"version":3,"file":"bundle.js","sources":["../src/utils/index.ts","../src/lib/report.ts","../src/lib/error.ts","../src/index.ts"],"sourcesContent":["/**\n * @description: 获取错误类型\n * @param {*} error.message\n * @return {*}\n */\nexport const getErrorType = (message: string): string => {\n  const errorTypes = ['ReferenceError', 'SyntaxError', 'TypeError', 'RangeError']\n  let type = 'OtherError'\n  errorTypes.forEach(i => {\n   if (message.indexOf(i) > -1) {\n    type = i\n   }\n  })\n  return type\n}\n","import {Error as ErrorType} from '../types/common' \n\nconst sessionStorageName = 'WATCHMAN_REPORT_STASH'\n\nexport interface reportType {\n  interval: number,\n  timer: null | number,\n  url: string\n}\n\ninterface options {\n  interval: number,\n  url: string\n}\nclass Report implements reportType {\n  interval: number\n  timer: number\n  url: string\n  constructor (options: options) {\n    this.interval = options.interval || 10 * 60 * 1000\n    this.url = options.url \n    this.timer = null\n    if (this.url) {\n      this.setReportInterval()\n    }\n  }\n\n  static send (error: ErrorType) {\n    let reportData = sessionStorage.getItem('sessionStorageName')\n    let result: ErrorType[] = []\n    if (!reportData) {\n      result = [error]\n    } else {\n      let parseData = JSON.parse(reportData)\n      parseData.push(error)\n      result = parseData\n    }\n    sessionStorage.setItem(sessionStorageName, JSON.stringify(result))\n  }\n\n  private setReportInterval () {\n    this.timer = window.setInterval(() => {\n      let errorData = sessionStorage.getItem(sessionStorageName)\n      if (errorData) {\n        fetch(this.url, {\n          body: errorData,\n          method: 'POST'\n        }).then(() => {\n          console.log('watchman report success', sessionStorage.getItem(sessionStorageName))\n        }).catch(() => {\n          clearInterval(this.timer)\n        })\n        sessionStorage.removeItem(sessionStorageName)\n      }\n    }, this.interval)\n  }\n\n  // setInterval (time: number) {\n  //   this.interval = time\n  //   clearInterval(this.timer)\n  //   this.setReportInterval()\n  // }\n}\n\nexport default Report\n","import { getErrorType } from '../utils/index'\nimport { Error } from '../types/common'\nimport Report from './report'\n/**\n * @description: \n *\n * @param {*}\n * @return {*}\n */\n\n\nclass CatchError {\n  constructor () {\n    window.addEventListener('error', (err) => {\n      console.log(err)\n      this.handleError(err)\n    }, true)\n    // window.onerror = (message, source, lineno, colno, error) => {\n    //   console.log('on error', message, source, lineno, colno, error)\n    // }\n\n    /**\n     * @description: promise 被reject 被catch时触发\n     * @param {*} \n     * @return {*}\n     */    \n    // window.onrejectionhandled = (e) => {\n    //   console.log('promise onrejectionhandled', e)\n    // }\n\n    /**\n     * @description: promise 被 reject 但是没有reject对应回掉时触发\n     * @param {*} e\n     * @return {*}\n     */    \n    window.onunhandledrejection = (e) => {\n      console.log('promise onunhandledrejection', e)\n      this.handlePromiseError(e)\n    }\n  }\n\n  private handleError (e) {\n    // srcElement === window 是全局错误 否则是 资源加载错误\n    const error:Error = {\n      type: ''\n    }\n    if (e.srcElement === 'window') {  // global error\n      error.message = e.srcElement.message\n      error.type = getErrorType(error.message)\n      error.lineno = error.lineno\n      error.colno = error.colno\n    } else {  // resource error\n      error.type = 'ResourceError'\n      error.tagName = e.srcElement.tagName\n      if (error.tagName === 'IMG' || error.tagName === 'SCRIPT') {\n        error.src = e.srcElement.src\n      }\n    }\n    console.log('handle error~~~~~~~~', error)\n    this.reportError(error)\n  }\n\n  private handlePromiseError (e) {\n    const error: Error = {\n      type: '',\n      reason: {}\n    }\n    error.type = e.type\n    error.reason = {\n      message: e.reason.message,\n      stack: e.reason.stack\n    }\n    console.log('~~~~~~~~~~~~~',error, e.reason)\n    Report.send(error)\n  }\n\n  private reportError (error) {\n    Report.send(error)\n  }\n}\n\n\nexport default CatchError","import CatchError from './lib/error'\nimport Report, {reportType} from './lib/report'\n\nclass WatchMan {\n  report: reportType\n  catchError: object\n  constructor (config ={}) {\n    this.catchError = null\n    this.report = null\n    this.init(config)\n  }\n  private init (config) {\n    this.catchError = new CatchError()\n    this.report = new Report({interval: config.interval, url: config.url})\n  }\n  send (data) {\n    Report.send(data)\n  }\n}\n\nexport default WatchMan\n"],"names":[],"mappings":"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"}